<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curiosity Coach - Rules</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px; /* Increased width for flowchart */
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #5a5a5a;
            text-align: center;
            margin-bottom: 30px;
        }
        /* Styles for Mermaid flowchart */
        .mermaid {
            text-align: center; /* Center the flowchart */
            margin-bottom: 30px;
        }
        /* Make flowchart nodes clickable */
        .mermaid .node {
             cursor: pointer;
        }
        .mermaid .node rect, .mermaid .node circle, .mermaid .node polygon, .mermaid .node ellipse {
            stroke: #333;
            fill: #eee;
        }
        .mermaid .node.clickable:hover rect,
        .mermaid .node.clickable:hover circle,
        .mermaid .node.clickable:hover polygon,
        .mermaid .node.clickable:hover ellipse {
             fill: #ddd;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 5% from the top and centered */
            padding: 30px;
            border: 1px solid #888;
            width: 90%; /* Changed from 70% */
            max-width: none; /* Removed 700px limit */
            max-height: 80vh; /* Limit height to 80% of viewport height */
            overflow-y: auto; /* Allow scrolling within the content area if needed */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
        }
        .modal h2 {
            margin-top: 0;
            color: #5a5a5a;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Content styling within modal */
        .content {
            padding: 0; /* Remove padding as modal-content has padding */
        }
        pre {
            background-color: #e9e9e9;
            padding: 15px; /* Slightly more padding */
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            line-height: 1.5; /* Adjust line height */
            margin-top: 10px;
            margin-bottom: 15px;
        }
    </style>
    <!-- Include Mermaid JS library -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Curiosity Coach - Processing Rules Flowchart</h1>

        <!-- Mermaid Flowchart Definition -->
        <div class="mermaid">
            graph TD
                A[User Query] --> B(1. Intent Gathering);
                B --> G{Needs Clarification?};
                G -->|Yes| H[Ask Follow-up Questions];
                H --> I[User Response];
                I --> J(Process Follow-up);
                J --> G;
                G -->|No| K{Check Intent Category};
                K -->|Educational| C(2. Knowledge Retrieval);
                K -->|Conversational| D(3. Initial Response Generation);
                K -->|Clarification| C(2. Knowledge Retrieval);
                K -->|Administrative| D(3. Initial Response Generation);
                K -->|Personal| D(3. Initial Response Generation);
                C --> D(3. Initial Response Generation);
                D --> L{Educational Intent?};
                L -->|Yes| E(4. Learning Enhancement);
                L -->|No| F[Send Response to Chat App];
                E --> F[Send Response to Chat App];

                %% Click interactions removed, will be added via JS
        </div>

        <!-- Modal for Intent Gathering -->
        <div id="intent-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('intent-modal')">&times;</span>
                <h2>1. Intent Gathering</h2>
                <div class="content">
                    <p>This step analyzes the student's query to determine if we need more context or if we can immediately identify their intent. The process may involve asking follow-up questions to better understand what the student wants to learn. The following prompt template is used:</p>
                    <pre>{{ intent_gathering_template }}</pre>
                    <p>After processing the query with the LLM, the system produces one of two possible JSON outputs:</p>
                    
                    <p><strong>1. When clarification is needed:</strong></p>
                    <pre>
{
    "needs_clarification": true,
    "follow_up_questions": [
        "What made you interested in learning about the Pope?",
        "What do you already know about the Pope or the Catholic Church?"
    ],
    "partial_understanding": "The student is asking about the Pope, likely referring to the head of the Catholic Church, but I need more context about their specific interests."
}</pre>

                    <p><strong>2. When intent is already clear:</strong></p>
                    <pre>
{
    "needs_clarification": false,
    "query": "Why is the sky blue during the day but red at sunset?",
    "subject": {
        "main_topic": "Rayleigh scattering",
        "related_topics": [
            "Atmospheric optics",
            "Light wavelengths",
            "Sunset colors"
        ]
    },
    "intent_category": "educational",
    "intents": {
        "primary_intent": {
            "category": "cognitive_intent",
            "specific_type": "Causal Exploration",
            "confidence": 0.92
        },
        "secondary_intent": {
            "category": "exploratory_intent",
            "specific_type": "Curiosity about Systems/Structures",
            "confidence": 0.78
        }
    },
    "context": {
        "known_information": "The student likely knows that the sky changes colors but doesn't understand the physics behind it",
        "motivation": "Genuine curiosity about a natural phenomenon they observe",
        "learning_goal": "Understanding the scientific explanation for sky colors"
    }
}</pre>

                    <p><strong>Intent Categories:</strong></p>
                    <ul>
                        <li><strong>educational</strong>: Questions about academic topics that require knowledge retrieval and learning enhancement</li>
                        <li><strong>conversational</strong>: Greetings, small talk, or social exchanges that don't need knowledge retrieval</li>
                        <li><strong>clarification</strong>: Questions about previously discussed topics or asking for explanations of previous responses</li>
                        <li><strong>administrative</strong>: Questions about how the system works or meta-questions about the interaction</li>
                        <li><strong>personal</strong>: Questions about preferences, opinions, or identity that don't require factual retrieval</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Modal for Follow-up Processing -->
        <div id="followup-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('followup-modal')">&times;</span>
                <h2>Follow-up Question Processing</h2>
                <div class="content">
                    <p>When the system asks follow-up questions, it processes the student's responses to gather more information about their intent. This enables more targeted and helpful answers.</p>
                    
                    <p><strong>For example:</strong></p>
                    <p>Original query: "Tell me more about the Pope."</p>
                    <p>Follow-up questions:</p>
                    <ul>
                        <li>What made you interested in learning about the Pope?</li>
                        <li>What do you already know about the Pope or the Catholic Church?</li>
                    </ul>
                    
                    <p>Student response: "I saw him on TV yesterday and my friends were talking about him. I know he's the leader of the Catholic Church and lives in Vatican City."</p>
                    
                    <p>The system then processes this response to build a complete understanding:</p>
                    <pre>
{
    "needs_clarification": false,
    "query": "Tell me more about the Pope.",
    "subject": {
        "main_topic": "The Pope (Catholic leadership)",
        "related_topics": [
            "Vatican City",
            "Papal duties",
            "Current Pope Francis",
            "Catholic Church"
        ]
    },
    "intents": {
        "primary_intent": {
            "category": "exploratory_intent",
            "specific_type": "Open-ended Exploration",
            "confidence": 0.88
        },
        "secondary_intent": {
            "category": "cognitive_intent",
            "specific_type": "Concept Clarification",
            "confidence": 0.65
        }
    },
    "context": {
        "known_information": "The student knows the Pope is the leader of the Catholic Church and resides in Vatican City",
        "motivation": "Current events - saw the Pope on television and heard friends discussing him",
        "learning_goal": "Understanding more about the Pope's role, significance, and current activities"
    }
}</pre>
                    <p>This comprehensive understanding allows the system to provide a response that is tailored to the student's actual interests and background knowledge.</p>
                </div>
            </div>
        </div>

        <!-- Modal for Knowledge Retrieval -->
        <div id="knowledge-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('knowledge-modal')">&times;</span>
                <h2>2. Knowledge Retrieval</h2>
                <div class="content">
                    <p>This step gathers relevant background information based on the identified topic and related topics. It is only executed for intent categories "educational" and "clarification". The following prompt template is used:</p>
                    <pre>{{ knowledge_prompt_template }}</pre>
                    <p>The LLM responds with relevant factual context. Here's an example output based on the topic "Rayleigh scattering":</p>
                    <pre>
Rayleigh scattering is the elastic scattering of light or other electromagnetic radiation by particles much smaller than the wavelength of the radiation. It is named after the British physicist Lord Rayleigh, who first described it in the 1870s.

Key points:
*   Scattering Intensity: Rayleigh scattering intensity is inversely proportional to the fourth power of the wavelength (I ∝ 1/λ⁴). This means shorter wavelengths (blue and violet light) are scattered much more strongly than longer wavelengths (red and orange light).
*   Particle Size: The effect is prominent when light interacts with particles much smaller than its wavelength, such as individual air molecules (oxygen and nitrogen) in the Earth's atmosphere.
*   Atmospheric Optics: This strong scattering of blue light by air molecules is why the daytime sky appears blue. Sunlight entering the atmosphere has all colors, but blue light gets scattered in all directions across the sky, making it appear blue when we look up.
*   Sunset Colors: At sunrise and sunset, sunlight travels through more of the atmosphere to reach our eyes. Most of the blue light is scattered away, leaving the longer wavelengths (reds and oranges) to dominate the light that reaches us directly, resulting in reddish skies.
*   Mie Scattering: Scattering by particles comparable to or larger than the wavelength of light (like water droplets, dust, or pollen) in described by Mie theory. Mie scattering is less wavelength-dependent and scatters light more in the forward direction. It contributes to the white glare around the sun and the white appearance of clouds.
*   Polarization: Rayleigh scattered light is also partially polarized.

Understanding Rayleigh scattering is crucial for explaining various natural phenomena related to atmospheric optics and color perception.</pre>
                </div>
            </div>
        </div>

        <!-- Modal for Initial Response Generation -->
        <div id="response-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('response-modal')">&times;</span>
                <h2>3. Initial Response Generation</h2>
                <div class="content">
                    <p>This step constructs a prompt dynamically to guide the LLM in generating an initial response. The prompt combines the user's query, the retrieved knowledge, and specific instructions based on the intents identified in Step 1.</p>

                    <p>The base structure of the prompt looks like this:</p>
                    <pre>
The student asked: "{{ '{{' }}USER QUERY{{ '}}' }}"

Use the following information to answer the question:
{{ '{{' }}KNOWLEDGE CONTEXT{{ '}}' }}

The student's context based on our conversation:
- What they already know: {{ '{{' }}KNOWN_INFORMATION{{ '}}' }}
- Why they're asking: {{ '{{' }}MOTIVATION{{ '}}' }}
- What they want to learn: {{ '{{' }}LEARNING_GOAL{{ '}}' }}

Now, generate a response that does the following:
{{ '{{' }}DYNAMIC INTENT-BASED INSTRUCTIONS{{ '}}' }}

Frame the response in a conversational tone aimed at a curious student aged 10-12.</pre>

                    <p>The <code>{{ '{{' }}DYNAMIC INTENT-BASED INSTRUCTIONS{{ '}}' }}</code> part is built by looking up the identified intents in the following mapping. For each non-null intent found, the corresponding instruction line is added to the prompt:</p>
                    <pre style="font-size: 0.9em; line-height: 1.4;">
cognitive_intent:
    Concept Clarification: "- Define the term in very simple language, relate it to a real-world analogy, and ask: 'Have you come across something like this before?'"
    Causal Exploration: "- Explain the reason behind the phenomenon step-by-step. Then end with a question like: 'Can you think of another place in the universe where this might also happen?'"
    Comparison Seeking: "- Give a contrast-based explanation with a table or analogy. Follow with: 'Which one do you think is cooler or more useful?'"
    Hypothetical Reasoning: "- Say: 'Let's imagine this was true… what would change around us?' and walk them through a scenario. End with: 'What else would you change in this imagined world?'"
    Application Inquiry: "- Start with: 'This might sound surprising, but this is used in real life like this…'. Then ask: 'Where else do you think this idea could be useful?'"
    Depth Expansion: "- Say: 'You already know the basics, so let's go one level deeper…'. Then offer an advanced idea and ask: 'Does this change how you see the original idea?'"

exploratory_intent:
    Open-ended Exploration: "- Give a fun fact or little-known detail and say: 'Want me to show you more fascinating stuff related to this?'"
    Topic Hopping: "- Mention 2–3 related ideas and ask: 'Want to jump into those next?'"
    Curiosity about Systems/Structures: "- Explain how the system's parts work together. Ask: 'What would happen if one part didn't work?'"

metacognitive_intent:
    Learning How to Learn: "- Give a technique or trick (e.g., memory method) and ask: 'Want to try using it on this topic?'"
    Interest Reflection: "- Link the topic to hobbies and say: 'Do you think this connects with what you already enjoy doing?'"

emotional_identity_intent:
    Identity Exploration: "- Say: 'It's okay to feel unsure. Let's explore this together step-by-step.' Then give an easy entry point."
    Validation Seeking: "- Say: 'That's a great thought — let me show you if that's true and why.'"
    Inspiration Seeking: "- Respond with awe: 'This is mind-blowing — let me show you why!'"

recursive_intent:
    Curiosity about Curiosity: "- Say: 'Curiosity is like gravity for the mind.' Then ask: 'What's the last thing that really pulled your attention like that?'"</pre>
                </div>
            </div>
        </div>

        <!-- Modal for Learning Enhancement -->
        <div id="enhancement-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('enhancement-modal')">&times;</span>
                <h2>4. Learning Enhancement</h2>
                <div class="content">
                    <p>This step takes the initial response and enhances it with pedagogical strategies to foster curiosity and deeper learning. It is only executed for intent category "educational". The following template is used:</p>
                    <pre>{{ learning_prompt_template }}</pre>
                    <p>This enhancement step transforms a straightforward explanatory response into one that actively engages the student's curiosity, invites further questions, and encourages exploration of the topic.</p>
                </div>
            </div>
        </div>

        <script>
            // Initialize Mermaid
            mermaid.initialize({
                startOnLoad: true,
                theme: 'default',
                flowchart: {
                    useMaxWidth: false, 
                    htmlLabels: true,
                    curve: 'basis'
                }
            });

            // After Mermaid has rendered, set up click handlers
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    // Click handler for Intent Identification
                    let intentNode = document.querySelector('.node:nth-child(3)'); // First node from the start
                    if (intentNode) {
                        intentNode.classList.add('clickable');
                        intentNode.addEventListener('click', function() {
                            openModal('intent-modal');
                        });
                    }

                    // Click handler for Follow-up Questions
                    let followupNode = document.querySelector('.node:nth-child(5)'); // Adjust as needed
                    if (followupNode) {
                        followupNode.classList.add('clickable');
                        followupNode.addEventListener('click', function() {
                            openModal('followup-modal');
                        });
                    }

                    // Click handler for Knowledge Retrieval
                    let knowledgeNode = document.querySelector('.node:nth-child(8)'); // Adjust based on your SVG structure
                    if (knowledgeNode) {
                        knowledgeNode.classList.add('clickable');
                        knowledgeNode.addEventListener('click', function() {
                            openModal('knowledge-modal');
                        });
                    }

                    // Click handler for Initial Response
                    let responseNode = document.querySelector('.node:nth-child(9)'); // Adjust based on your SVG structure
                    if (responseNode) {
                        responseNode.classList.add('clickable');
                        responseNode.addEventListener('click', function() {
                            openModal('response-modal');
                        });
                    }

                    // Click handler for Learning Enhancement
                    let enhancementNode = document.querySelector('.node:nth-child(10)'); // Last node
                    if (enhancementNode) {
                        enhancementNode.classList.add('clickable');
                        enhancementNode.addEventListener('click', function() {
                            openModal('enhancement-modal');
                        });
                    }
                }, 1000); // Give time for Mermaid to render
            });

            // Functions to open and close modals
            function openModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            // Close modal when clicking outside of it
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            }
        </script>
    </div>
</body>
</html> 